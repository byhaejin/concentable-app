<template>
    <div class="page mypage">
         <sub-header title="1:1문의"  nomenu="true"></sub-header>

        <!-- messagebar -->
        <div class="toolbar messagebar messagebar-init" data-max-height="200">
            <div class="toolbar-inner">
                <div class="messagebar-area">                    
                    <!-- <textarea class="resizable" placeholder="Message"></textarea> -->
                    <textarea placeholder="Message"></textarea>
                </div>
                <a href="#" class="link send-link">입력</a>
            </div>
            <div class="messagebar-sheet"></div>
        </div>
        
        <!-- page-content/messages-content -->
        <div class="page-content messages-content">
            <div class="padding">
                <div class="messages">
                    <hr class="width-100" />
                    <div class="text-align-center text-color-gray update"><b>{{today}}</b></div>

                    <!-- message add -->
                </div>
            </div>
        </div>
    </div>
</template>
<script>
    return {
        data: function () {
            return {
                messages: null,
                messagebar: null,
                responseInProgress: false,
                today: moment().format('ll')
            }
        },
        methods: {

        },
        on: {
            pageInit: function () {
                const _self = this;

                this.messages = app.messages.create({
                    el: '.messages',

                    // First message rule
                    firstMessageRule: function (message, previousMessage, nextMessage) {
                        // Skip if title
                        if (message.isTitle) return false;
                        /* if:
                          - there is no previous message
                          - or previous message type (send/received) is different
                          - or previous message sender name is different
                        */
                        if (!previousMessage || previousMessage.type !== message.type || previousMessage.name !== message.name) return true;
                        return false;
                    },
                    // Last message rule
                    lastMessageRule: function (message, previousMessage, nextMessage) {
                        // Skip if title
                        if (message.isTitle) return false;
                        /* if:
                          - there is no next message
                          - or next message type (send/received) is different
                          - or next message sender name is different
                        */
                        if (!nextMessage || nextMessage.type !== message.type || nextMessage.name !== message.name) return true;
                        return false;
                    },
                    // Last message rule
                    tailMessageRule: function (message, previousMessage, nextMessage) {
                        // Skip if title
                        if (message.isTitle) return false;
                        /* if (basically same as lastMessageRule):
                        - there is no next message
                        - or next message type (send/received) is different
                        - or next message sender name is different
                      */
                        if (!nextMessage || nextMessage.type !== message.type || nextMessage.name !== message.name) return true;
                        return false;
                    }
                });

                _self.messagebar = app.messagebar.create({
                    el: '.messagebar'
                });

                // Send Message
                $$('.send-link').on('click', function () {
                    var text =  _self.messagebar.getValue().replace(/\n/g, '<br>').trim();

                    // return if empty message
                    if (!text.length) return;

                    // Clear area
                    _self.messagebar.clear();

                    // Return focus to area
                    _self.messagebar.focus();

                    // Add message to messages
                    _self.messages.addMessage({
                        text: text,
                        name: moment().format('LT'),
                    });

                    if (_self.responseInProgress) return;

                    // Receive dummy message
                    receiveMessage();
                });

                /** 이하 가상의 메시지 답변처리 */
                var answers = [
                    '맞습니다!',
                    '아니오',
                    '아...',
                    '잘 모르 겠습니다.',
                    '당신을 무엇을 하고 싶습니까?',
                    '아마도.. ;)',
                    '확인해보고 다시 안내해 드리겠습니다.',
                    '뭔가요?',
                    '확신하시나요?',
                    '물론 입니다.',
                    '다른일에 대해 알아야 될거 같네요.',
                    '훌륭해요!!!'
                ]
                var people = [
                    {
                        name: '컨센터블',
                        avatar: '../static/images/people-100x100-1.png'
                    },
                    {
                        name: '상담원 1',
                        avatar: '../static/images/people-100x100-2.png'
                    }
                ];

                /** 가상 메세지 답변 **/
                function receiveMessage() {
                    _self.responseInProgress = true;
                    setTimeout(function () {
                        // Get random answer and random person
                        var answer = answers[Math.floor(Math.random() * answers.length)];
                        var person = people[Math.floor(Math.random() * people.length)];

                        // Show typing indicator
                        _self.messages.showTyping({
                            header: person.name + ' is typing',
                            avatar: person.avatar
                        });

                        setTimeout(function () {
                            // Add received dummy message
                            _self.messages.addMessage({
                                text: answer,
                                type: 'received',
                                name: person.name + ' ' + moment().format('LT'),
                                avatar: person.avatar
                            });
                            // Hide typing indicator
                            _self.messages.hideTyping();
                            _self.responseInProgress = false;
                        }, 4000);
                    }, 1000);
                }
            }
        },
    }
</script>